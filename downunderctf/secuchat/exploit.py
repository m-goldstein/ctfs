"""
Table: User
    username: text
    rsa_key: blob

Table: Parameters:
    id: int
    encrypted_aes_key_for_initiator: blob
    encrypted_aes_key_for_peer: blob
    iv: blob

Table: sqlite_sequence(name,seq)

Table: Conversation
    id: int
    initiator: text
    peer: text
    initial_parameteres: int
    foreign key (initiator) references User(username)
    foreign key (peer) references User(username)
    foreign key (initial_paramteres) references Parameters(id)
    unique(initiator,peer)

Table: Message:
    conversation: int
    timestamp: int
    from_initiator: bool
    next_paramters: bool
    encrypted_msg: blob
    foreign key (conversation) references Conversation(id)
    foreign key (next_parameters) references Parameters(id)
"""
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP
from codecs import encode,decode
import os
import sys
import json
from Crypto.Cipher import AES
from Crypto.Util.number import long_to_bytes,bytes_to_long,GCD,inverse,getPrime
import base64 as b64
b64encode = b64.b64encode
b64decode = b64.b64decode
def egcd(a,b):
    s1,s2 = 1,0
    t1,t2 = 0,1
    while b != 0:
        q = a//b
        r = a%b
        a,b= b,r
        s = s1-q*s2
        s1,s2 = s2,s
        t = t1-q*t2
        t1,t2=t2,t
    return (s1,t1)

def pad(s,BLOCK_SIZE=AES.block_size,PADDING=b'\x00'):
    if type(s) != type(b'a'):
        s = decode(s,'hex')
    if len(s) % BLOCK_SIZE:
        return (s + ((BLOCK_SIZE-(len(s)%BLOCK_SIZE))*PADDING))
    else:
        return s
# n -- integer
# k -- kth root
def iroot(n, k):
    u,s = n,n+1
    while u < s:
        s = u
        t = (k-1)*s+n // pow(s,k-1)
        u = t//k
    return s

def parse_sqldata(data,keys=[]):
    try:
        ret = []
        splitted = [e.rstrip() for e in data.split('INSERT INTO "table" VALUES') if len(e)]
        for i in range(len(splitted)):
            e = splitted[i]
            if e.startswith('('):
                e = e[1:]
            if e.endswith(');'):
                e = e[:-2]
            elif e.endswith(';'):
                e = e[:-1]
            splitted[i] = e
        for e in splitted:
            d = {}
            entries = e.split(',')
            for i in range(len(keys)):
                key = keys[i]
                entry = entries[i]
                if entry.startswith("X'") and entry.endswith("'"):
                    entry = entry[2:-1]
                d[key] = entry
            ret.append(d)
        return ret
    except Exception as e:
        print(f"Exception: {e}")

# open the files (extracted using sqlite3)
fconversation_data = open('conversationdata.sql','r')
fmsg_data = open('msgdata.sql','r')
fparam_data = open('paramdata.sql','r')
fuser_data = open('userdata.sql','r')
fsqlite_sequence_data = open('sqlite_sequence_data.sql','r')
wordlist = open('words','r')
words = wordlist.read().split('\n')[:-1]
# read contents into buffers
raw_conversation_data = fconversation_data.read()
raw_msg_data = fmsg_data.read() 
raw_param_data = fparam_data.read() 
raw_user_data = fuser_data.read() 
raw_sqlite_sequence_data = fsqlite_sequence_data.read() 

# make into list of dictionaries
conversation_data = parse_sqldata(raw_conversation_data, keys=['id','initiator','peer','params'])
msg_data = parse_sqldata(raw_msg_data, keys=['conversation','timestamp','from_initiator','next_params','encrypted_msg'])
param_data = parse_sqldata(raw_param_data, keys=['id','aes_key_initiator','aes_key_peer','iv'])
user_data = parse_sqldata(raw_user_data, keys=['username','rsakey'])
sqlite_sequence_data = parse_sqldata(raw_sqlite_sequence_data, keys=['name','seq'])

asciz = [e for e in range(0x20,0x7f)]
keys = [key for key in conversation_data[0].keys()]
w = [(e['username'],RSA.import_key(decode(e['rsakey'],'hex'))) for e in user_data]
x = [[f'gcd({i},{j})={GCD(w[i][1].n,w[j][1].n)}' for i in range(len(w)) if i != j] for j in range(len(w))]


# eriksaunders
p23 = GCD(w[23][1].n, w[1][1].n)
q23 = (w[23][1].n // p23)
phi23 = (p23-1)*(q23-1)
sd23 = inverse(w[23][1].e, phi23)


# hortonashley
p1 = (w[1][1].n // p23)
q1 = (w[1][1].n // p1)
phi1 = (p1-1)*(q1-1)
sd1 = inverse(w[1][1].e, phi1)

for i in range(len(user_data)):
    e = user_data[i]
    if e['username'] == "'hortonashley'":
        e['rsa_privkey'] = sd1
    elif e['username'] == "'eriksaunders'":
        e['rsa_privkey'] = sd23
    user_data[i] = e
    
for d in conversation_data:
    id = d['id']
    initiator = d['initiator']
    peer = d['peer']
    params = d['params']
    
    initiator_userdata = [e for e in user_data if e['username'] == initiator][0]
    peer_userdata = [e for e in user_data if e['username'] == peer][0]

    # RSA2048-OAEP stuff
    initiator_rsakey = [e['rsakey'] for e in user_data if e['username'] == initiator][0]
    peer_rsakey = [e['rsakey'] for e in user_data if e['username'] == peer][0]
    initiator_rsakey = RSA.import_key(decode(initiator_rsakey,'hex'))
    peer_rsakey = RSA.import_key(decode(peer_rsakey,'hex'))

    peer_rsacipher = PKCS1_OAEP.new(peer_rsakey)
    initiator_rsacipher = PKCS1_OAEP.new(initiator_rsakey)


    conversation_paramdata = [e for e in param_data if e['id'] == params][0]


    # AES256-CBC stuff
    initiator_aeskey = conversation_paramdata['aes_key_initiator']
    peer_aeskey = conversation_paramdata['aes_key_peer']
    conversation_iv = conversation_paramdata['iv']

    conversation_msgdata = [e for e in msg_data if e['conversation'] == id]
    conversation_msgdata = sorted(conversation_msgdata, key=lambda x: x['timestamp'])
    for e in conversation_msgdata:
        use_initiator_key = True if e['from_initiator'] == '1' else False
        iv = decode(conversation_iv,'hex')
        peer_aeskey_b = decode(peer_aeskey,'hex')
        peer_aeskey_l = int(peer_aeskey, 16)
        initiator_aeskey_b = decode(initiator_aeskey, 'hex')
        initiator_aeskey_l = int(initiator_aeskey, 16)
        next_params = [f for f in param_data if f['id'] == e['next_params']][0]
        ciphertext = decode(e['encrypted_msg'], 'hex')
        if d['initiator'] == "'hortonashley'" or d['initiator'] == "'eriksaunders'":
            initiator_aeskey_dec = pow(long_to_bytes(initiator_aeskey_l), initiator_userdata['rsa_privkey'], initiator_rsakey.n)
            initiator_cipher = AES.new(initiator_aeskey_dec, AES.MODE_CBC, iv=iv)
            print(b'decrypted: {initiator_cipher.decrypt(ciphertext)}')
        elif d['peer'] == "'hortonashley'" or d['peer'] == "'eriksaunders'":
            peer_aeskey_dec = pow(peer_aeskey_l, peer_userdata['rsa_privkey'], peer_rsakey.n)
            peer_cipher = AES.new(long_to_bytes(peer_aeskey_dec), AES.MODE_CBC, iv=iv)
            print(b'decrypted: {peer_cipher.decrypt(ciphertext)}')
